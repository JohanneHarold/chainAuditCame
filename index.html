<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consensus Chronicle - GenLayer</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(167,139,250,0.3); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef } = React;

const CONFIG = { ROOM_SIZE: { min: 4, max: 8 }, DEBATE_DURATION: 90, VOTE_DURATION: 30, TOTAL_ROUNDS: 5, ENTRY_FEE: 10, BASE_REWARD: 50, WIN_BONUS: 20, DEBATE_BONUS: 5 };

// GenLayer Contract Config
const GENLAYER_CONFIG = {
  CONTRACT_ADDRESS: '0xConsensusChronicle',
  NETWORK: 'genlayer-testnet',
  RPC_URL: 'https://studio.genlayer.com/api'
};

const STORY_ARCS = {
  fantasy: {
    name: 'Fantasy Quest', icon: 'ğŸ°', desc: '5-round epic story',
    opening: 'The ancient prophecy has come trueâ€”the Black Dragon awakens after a thousand years. The kingdom is in peril. The King summons heroes from across the realm to decide the fate of all...',
    rounds: [
      { context: 'The dragon threat is imminent. The kingdom must make its first crucial decision.',
        a: { text: 'Mobilize the army immediately and strike the dragon lair before it fully awakens.', tag: 'Aggressive', consequence: 'The army marches toward the lair, but encounters fierce resistance...' },
        b: { text: 'Send envoys to seek help from the Elven Kingdomâ€”they sealed the dragon once before.', tag: 'Diplomatic', consequence: 'The envoys reach the elves, but they demand a steep price...' } },
      { context: 'The situation develops based on the previous choice.', contextA: 'Heavy losses sustained, but the army nears the lair. Scouts report: dragon eggs found inside.',
        contextB: 'The Elves demand the Sacred Sword as proof of trust, or they will not help.',
        a: { text: 'Destroy the eggs. End the dragon bloodline forever.', tag: 'Ruthless', consequence: 'The eggs are destroyed, changing everything...', consequenceFromA: 'The eggs are destroyed. The dragon flies into a rage...', consequenceFromB: 'Refusing the elves, humans destroy the eggs alone...' },
        b: { text: 'Preserve the eggs. Perhaps they can be used to negotiate.', tag: 'Merciful', consequence: 'The eggs are protected...', consequenceFromA: 'The eggs are protected, but word leaks causing strife...', consequenceFromB: 'Trading the sword for elven aid while protecting eggs...' } },
      { context: 'The conflict reaches a critical point.', contextAA: 'The enraged dragon unleashes devastating power. The army faces annihilation.', contextAB: 'Internal conflict weakens morale. Some want to surrender.', contextBA: 'Without elven magic, the human army struggles in combat.', contextBB: 'Elven forces arrive but threaten to leave upon learning of the eggs.',
        a: { text: 'Use forbidden magic. The caster sacrifices their life to wound the dragon.', tag: 'Sacrifice', consequence: 'The forbidden spell works. The dragon falls wounded, but at terrible cost...' },
        b: { text: 'Order a retreat. Preserve strength for a better opportunity.', tag: 'Strategic', consequence: 'The army retreats safely, but the dragon destroys several villages...' } },
      { context: 'A turning point arrives.', contextA: 'The wounded dragon retreats to heal. Dark energy shrouds the region.', contextB: 'After retreat, the kingdom reflects. New voices emerge among the people.',
        a: { text: 'Launch a final assault while the dragon heals. End this now.', tag: 'Decisive', consequence: 'The final assault begins. This battle will determine the kingdoms fate...' },
        b: { text: 'Attempt to communicate with the wounded dragon. Seek peace.', tag: 'Peaceful', consequence: 'An envoy approaches the dragon. Surprisingly, it agrees to talk...' } },
      { context: 'The final chapter unfolds.', contextA: 'In the final battle, both sides suffer greatly. Victory hangs in the balance.', contextB: 'The dragon reveals it awakened because of a greater threatâ€”a demon god rises.',
        a: { text: 'Spare nothing to destroy the dragon, even if the kingdom burns.', tag: 'Total War', consequence: 'All-out war begins...', ending: 'The dragon falls, but so does most of the kingdom. Survivors begin rebuilding. History remembers this pyrrhic victory.' },
        b: { text: 'Forge an alliance with the dragon against future threats.', tag: 'Unity', consequence: 'An alliance forms...', ending: 'Humans and dragon forge an unprecedented pact against the coming darkness. A new era dawns.' } }
    ]
  },
  scifi: {
    name: 'Stellar Crisis', icon: 'ğŸš€', desc: '5-round epic story',
    opening: 'Year 2157. Mars Colony "New Hope" receives a mysterious deep space signal. Scientists decode it: Earth will be struck by an asteroid in 100 days. Resources can only save half the population...',
    rounds: [
      { context: 'Panic spreads after the announcement. Leadership must decide immediately.',
        a: { text: 'Launch "Ark Protocol"â€”use lottery to determine who boards escape ships.', tag: 'Fair', consequence: 'Lottery results announced. Those left behind begin protests...' },
        b: { text: 'Focus resources on analyzing the signal source. Perhaps salvation lies there.', tag: 'Hopeful', consequence: 'Research reveals the signal comes from an unknown civilization...' } },
      { context: 'The situation escalates.', contextA: 'Protests escalate into riots. Some occupy the ship launch facility.', contextB: 'The alien civilization invites humanity to a distant galaxyâ€”500 year journey.',
        a: { text: 'Authorize security forces to use force. Ensure protocol proceeds.', tag: 'Order', consequence: 'Order is restored...', consequenceFromA: 'Riots suppressed. Many die, survivors harbor resentment...', consequenceFromB: 'Abandoning alien contact, focusing on escape plans...' },
        b: { text: 'Negotiate with protesters. Modify the plan to save more.', tag: 'Humane', consequence: 'Negotiations begin...', consequenceFromA: 'Engineers propose overloading shipsâ€”risky but saves more...', consequenceFromB: 'Sending advance team while others enter cryosleep...' } },
      { context: 'Critical decisions must be made.', contextAA: 'Overloading reduces success from 95% to 60%, but saves 30% more people.', contextAB: 'Advance team loses contact. Resources last only 60 days.', contextBA: 'Extremists plot to sabotage the ships.', contextBB: 'Cryosleep technology has 30% failure rate.',
        a: { text: 'Accept overload plan. Trade success rate for more hope.', tag: 'Gamble', consequence: 'Overload plan initiated. Everyone prays for a miracle...' },
        b: { text: 'Maintain original plan. Ensure half definitely survive.', tag: 'Safe', consequence: 'Original plan proceeds, but social fractures cannot heal...' } },
      { context: 'New possibilities emerge.', contextA: 'Before launch, AI detects: the asteroids trajectory can be altered.', contextB: 'Advance team transmits: aliens can destroy asteroid, but humanity must disarm.',
        a: { text: 'Attempt to alter the asteroids path. Worth trying.', tag: 'Heroic', consequence: 'All colony energy focused on this audacious plan...' },
        b: { text: 'Proceed with evacuation. Dont risk everything.', tag: 'Cautious', consequence: 'Ships begin evacuation, but hope remains...' } },
      { context: 'The final moment arrives.', contextA: 'Trajectory alteration used 80% energy. Asteroid shifted but not enough.', contextB: 'Alien technology works, but they demand all nuclear weapons destroyed.',
        a: { text: 'Go all in. Use remaining energy. All or nothing.', tag: 'Last Stand', consequence: 'Everything committed...', ending: 'Miracle! The asteroid veers away. Humanity conquers fate through courage.' },
        b: { text: 'Accept partial loss. Begin disaster recovery.', tag: 'Realistic', consequence: 'Preparations begin...', ending: 'The asteroid grazes Earth, causing severe damage. Survivors rebuild.' } }
    ]
  },
  mystery: {
    name: 'Murder Mystery', icon: 'ğŸ”', desc: '5-round epic story',
    opening: 'A stormy night. Wealthy Mr. Chen is poisoned in his locked study. Present: son Chen Ming, daughter Chen Yue, butler Zhang, maid Fang, and mysterious businessman Mr. Li. Everyone has secrets...',
    rounds: [
      { context: 'Police seal the mansion. As the detective, you must begin investigating.',
        a: { text: 'Search the victims study first. Look for physical evidence.', tag: 'Evidence', consequence: 'A half-burned letter found with words "betrayal" and "inheritance"...' },
        b: { text: 'Interview each person. Observe reactions and inconsistencies.', tag: 'Intuition', consequence: 'Butler Zhang appears nervous. Chen Yue mentions threats...' } },
      { context: 'New leads emerge from the investigation.', contextA: 'The letter reveals Mr. Chen planned to change his will, disinheriting someone.', contextB: 'The threats came from a mysterious organization. Mr. Li seems connected.',
        a: { text: 'Investigate the inheritance issue. Follow the money.', tag: 'Financial', consequence: 'Financial trails reveal secrets...', consequenceFromA: 'Chen Ming has gambling debts. Chen Yue funds a secret charity...', consequenceFromB: 'Mr. Chen transferred large assets, destination unknown...' },
        b: { text: 'Investigate Mr. Lis identity. His appearance is too convenient.', tag: 'Suspicious', consequence: 'Identity revealed...', consequenceFromA: 'Mr. Li is Mr. Chens illegitimate son...', consequenceFromB: 'Mr. Li brings a shocking secret...' } },
      { context: 'The investigation deepens.', contextAA: 'Chen Ming has motive, but has alibiâ€”maid Fang testifies.', contextAB: 'Asset destination is an overseas account with encrypted owner.', contextBA: 'The illegitimate son means inheritance redistributionâ€”all have motive.', contextBB: 'Mr. Li reveals Mr. Chen was investigating a covered-up murder.',
        a: { text: 'Verify Fangs testimony. She could be accomplice.', tag: 'Thorough', consequence: 'Under pressure, Fang admits Chen Ming threatened her to lie...' },
        b: { text: 'Investigate the old case. Past secrets reveal present truth.', tag: 'Historical', consequence: 'Old case leads to a fire 20 years ago where first wife died...' } },
      { context: 'Shocking revelations emerge.', contextA: 'False testimony exposed. Chen Ming insists innocence, accuses Chen Yue.', contextB: 'The fire was arson. Mr. Chen may have known the true culprit.',
        a: { text: 'Cross-examine both. Find who is lying.', tag: 'Direct', consequence: 'Stunning: Chen Yue isnt Mr. Chens biological daughter...' },
        b: { text: 'Re-examine poison source. Murder weapon points to killer.', tag: 'Scientific', consequence: 'Poison from rare plantâ€”one in butler Zhangs room...' } },
      { context: 'The truth awaits revelation.', contextA: 'Chen Yue is daughter of someone who "died" 20 years ago, secretly adopted.', contextB: 'Evidence points to Zhang, but he has heart attack, leaving: "Truth under old tree..."',
        a: { text: 'Reveal all truth. Let law decide.', tag: 'Justice', consequence: 'Justice served...', ending: 'Truth: Zhang was lover of first wife. They planned the fire. When Chen discovered, Zhang killed him.' },
        b: { text: 'Give parties a choice. Some truths shouldnt be revealed.', tag: 'Mercy', consequence: 'Mercy shown...', ending: 'Zhangs crimes handled quietly. Some truths buried, but living get fresh starts.' } }
    ]
  },
  political: {
    name: 'Court Intrigue', icon: 'ğŸ‘‘', desc: '5-round epic story',
    opening: 'Great Qi Dynasty. The old Emperor passes. His will shocks: throne goes to "whoever best represents peoples will." Three princes compete. As Grand Chancellor, you must navigate...',
    rounds: [
      { context: 'Three princes: Crown Princeâ€”kind but weak; Secondâ€”cunning but cruel; Thirdâ€”young but reform-minded.',
        a: { text: 'Support Crown Prince per tradition. Uphold stability.', tag: 'Traditional', consequence: 'Crown Prince gains confidence, but Second Prince contacts military...' },
        b: { text: 'Propose all princes present plans. Let officials decide.', tag: 'Democratic', consequence: 'Reformers cheer, conservatives oppose...' } },
      { context: 'Political tensions rise.', contextA: 'Second Prince allies with generals, plots to "cleanse the court."', contextB: 'Before council, Third Prince accused of treason via foreign correspondence.',
        a: { text: 'Mobilize Imperial Guard. Divide Second Princes alliance.', tag: 'Cunning', consequence: 'Counter-moves made...', consequenceFromA: 'Scheme delays Second Prince, but he suspects betrayal...', consequenceFromB: 'Investigation suggests letter may be forged...' },
        b: { text: 'Negotiate with Second Prince. Seek peace.', tag: 'Peaceful', consequence: 'Negotiations begin...', consequenceFromA: 'Second offers terms: throne but spare brothers...', consequenceFromB: 'You investigate the forgery yourself...' } },
      { context: 'Power struggles intensify.', contextAA: 'Second Princes ally turned, but demands Prime Minister position.', contextAB: 'Letter forged by Empress Dowagers faction to enthrone her nephew.', contextBA: 'Second Princes terms unacceptable, but he has armies. Refusal risks war.', contextBB: 'Empress Dowager demands "regency" as late Emperors widow.',
        a: { text: 'Accept the demands. Lesser evil for stability.', tag: 'Pragmatic', consequence: 'A deal is struck...' },
        b: { text: 'Expose the conspiracy. Unite princes against common enemy.', tag: 'Righteous', consequence: 'Three princes stand together...' } },
      { context: 'Crisis and opportunity intertwine.', contextA: 'Powers balanced, succession unresolved. Then: northern nomads at border.', contextB: 'Empress confined. Another will found from late Emperor...',
        a: { text: 'Propose princes campaign north. Victor becomes Emperor.', tag: 'Meritocratic', consequence: 'Three princes march north...' },
        b: { text: 'Select Emperor first. Nation needs ruler.', tag: 'Orderly', consequence: 'Decisive court session begins...' } },
      { context: 'The dynastys fate hangs in balance.', contextA: 'Northern campaign: Crown Prince wins hearts, Second fights bravely, Third manages logistics.', contextB: 'True will: throne to "whoever makes three sons coexist peacefully." That person is you.',
        a: { text: 'Propose shared ruleâ€”"Three Kings Council."', tag: 'Innovative', consequence: 'New system proposed...', ending: 'Great Qi enters "Three Kings Era." Despite disputes, system works under your mediation.' },
        b: { text: 'Rank by military merit. Greatest contributor takes throne.', tag: 'Fair', consequence: 'Merit decides...', ending: 'Second Prince claims throne by merit. He brings renaissance. "Without you, no Great Qi today."' } }
    ]
  }
};

const AI_PLAYERS = [
  { id: 'ai_1', name: 'Sage Iris', avatar: 'ğŸ§™â€â™€ï¸', style: 'analytical' },
  { id: 'ai_2', name: 'Knight Kane', avatar: 'âš”ï¸', style: 'bold' },
  { id: 'ai_3', name: 'Scholar Noah', avatar: 'ğŸ“š', style: 'cautious' },
  { id: 'ai_4', name: 'Merchant Marco', avatar: 'ğŸ’°', style: 'pragmatic' },
  { id: 'ai_5', name: 'Poet Luna', avatar: 'ğŸ­', style: 'romantic' },
];

const genAI = (style) => {
  const d = { analytical: { A: ['Logically, A has higher success rate.', 'Data favors option A.'], B: ['Analysis shows B is wiser.', 'B is the prudent choice.'] }, bold: { A: ['Fortune favors the bold! Choose A!', 'Strike decisively! A!'], B: ['True courage is choosing B!', 'B shows real bravery!'] }, cautious: { A: ['Risky but perhaps necessary. A.', 'I cautiously support A.'], B: ['Safety firstâ€”choose B.', 'B is the wise choice.'] }, pragmatic: { A: ['ROI favors A.', 'A pays off better.'], B: ['B is more controlled.', 'B makes business sense.'] }, romantic: { A: ['A has poetic beauty.', 'A will become legend.'], B: ['B represents hope.', 'B moves my heart.'] } };
  const c = Math.random() > 0.5 ? 'A' : 'B';
  return { text: (d[style]?.[c] || d.analytical[c])[Math.floor(Math.random() * 2)], choice: c };
};

const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } };
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

function App() {
  // ===== Wallet State (GenLayer) =====
  const [wallet, setWallet] = useState({ connected: false, address: '', balance: 0 });
  const [connecting, setConnecting] = useState(false);

  // ===== Game State =====
  const [view, setView] = useState('home');
  const [player, setPlayer] = useState(() => load('cc_p', { id: `p_${Date.now()}`, name: '', avatar: 'ğŸ®', tokens: 100, earned: 0 }));
  const [room, setRoom] = useState(null);
  const [players, setPlayers] = useState([]);
  const [round, setRound] = useState(0);
  const [phase, setPhase] = useState('waiting');
  const [timer, setTimer] = useState(0);
  const [story, setStory] = useState([]);
  const [path, setPath] = useState([]);
  const [opts, setOpts] = useState({ a: null, b: null });
  const [votes, setVotes] = useState({});
  const [myVote, setMyVote] = useState(null);
  const [scores, setScores] = useState({});
  const [msgs, setMsgs] = useState([]);
  const [input, setInput] = useState('');
  const [ended, setEnded] = useState(false);
  const [history, setHistory] = useState(() => load('cc_h', []));
  const [lb, setLb] = useState(() => load('cc_lb', []));
  
  const timerRef = useRef(null);
  const chatRef = useRef(null);
  const endedRef = useRef(false);
  const roomRef = useRef(null);
  const playersRef = useRef([]);
  const votesRef = useRef({});
  const scoresRef = useRef({});

  useEffect(() => { save('cc_p', player); }, [player]);
  useEffect(() => { chatRef.current?.scrollTo(0, chatRef.current.scrollHeight); }, [msgs]);
  useEffect(() => { endedRef.current = ended; }, [ended]);
  useEffect(() => { roomRef.current = room; }, [room]);
  useEffect(() => { playersRef.current = players; }, [players]);
  useEffect(() => { votesRef.current = votes; }, [votes]);
  useEffect(() => { scoresRef.current = scores; }, [scores]);

  // ===== GenLayer Wallet Connection =====
  const connectWallet = async () => {
    setConnecting(true);
    try {
      // Simulate GenLayer wallet connection
      await new Promise(r => setTimeout(r, 1500));
      const addr = '0x' + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');
      const bal = Math.floor(Math.random() * 500) + 100;
      setWallet({ connected: true, address: addr, balance: bal });
      setPlayer(p => ({ ...p, tokens: bal, name: p.name || `Player_${addr.slice(-4)}` }));
      msg('ğŸ”— Connected to GenLayer Testnet!');
    } catch (e) {
      console.error(e);
      msg('âŒ Connection failed');
    }
    setConnecting(false);
  };

  const disconnectWallet = () => {
    setWallet({ connected: false, address: '', balance: 0 });
    msg('ğŸ”Œ Wallet disconnected');
  };

  // Contract interaction (simulated)
  const callContract = async (method, params) => {
    console.log(`[GenLayer] ${method}:`, params);
    await new Promise(r => setTimeout(r, 300));
    return { success: true, tx: '0x' + Math.random().toString(16).slice(2, 10) };
  };

  const fmt = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
  const msg = (t, type='system', sender=null, choice=null) => setMsgs(p => [...p.slice(-40), { id: Date.now(), type, text: t, sender, choice }]);

  // FIX: Improved getRd function with better fallback
  const getRd = (r, p, theme) => { 
    const arc = STORY_ARCS[theme]; 
    if (!arc) return null;
    const rd = arc.rounds[r-1]; 
    if (!rd) return null; 
    
    // Get context based on path
    let ctx = rd.context; // Default fallback
    if (r > 1 && p && p.length > 0) { 
      if (r === 2) {
        // Round 2: look for contextA or contextB
        const key = `context${p[p.length-1]}`;
        ctx = rd[key] || rd.context;
      } else {
        // Round 3+: look for contextAA, contextAB, etc.
        const k = p.slice(-2).join(''); 
        ctx = rd[`context${k}`] || rd[`context${p[p.length-1]}`] || rd.context; 
      }
    }
    return { ...rd, context: ctx || 'The story continues...' }; 
  };
  
  const getRes = (r, c, p, theme) => { 
    const rd = STORY_ARCS[theme]?.rounds[r-1]; 
    if (!rd) return ''; 
    const o = c === 'A' ? rd.a : rd.b; 
    if (!o) return '';
    // Check for path-specific consequence
    if (p && p.length > 0) { 
      const k = `consequenceFrom${p[p.length-1]}`; 
      if (o[k]) return o[k]; 
    } 
    // Final round ending or regular consequence
    return (r === CONFIG.TOTAL_ROUNDS && o.ending) ? o.ending : (o.consequence || ''); 
  };

  const createRoom = async (theme) => {
    if (player.tokens < CONFIG.ENTRY_FEE) { alert(`Need ${CONFIG.ENTRY_FEE} GLT!`); return; }
    
    // Contract call
    if (wallet.connected) {
      await callContract('joinGame', { theme, fee: CONFIG.ENTRY_FEE });
    }
    
    setPlayer(p => ({ ...p, tokens: p.tokens - CONFIG.ENTRY_FEE }));
    const newRoom = { id: `room_${Date.now()}`, theme, host: player.id };
    setRoom(newRoom);
    roomRef.current = newRoom;
    setPlayers([player]); 
    setView('room'); 
    setStory([]); 
    setPath([]); 
    setEnded(false); 
    endedRef.current = false;
    setMsgs([]);
    setOpts({ a: null, b: null });
    setVotes({});
    setMyVote(null);
    setScores({});
    
    msg(`Room created. -${CONFIG.ENTRY_FEE} GLT`);
    
    const ais = [...AI_PLAYERS].sort(() => Math.random() - 0.5).slice(0, 3 + Math.floor(Math.random() * 2));
    ais.forEach((ai, i) => setTimeout(() => { 
      setPlayers(p => p.length < CONFIG.ROOM_SIZE.max ? [...p, { ...ai, isAI: true }] : p); 
      msg(`${ai.avatar} ${ai.name} joined`); 
    }, 600 * (i + 1)));
  };

  const startGame = () => {
    if (players.length < CONFIG.ROOM_SIZE.min) { msg(`Need ${CONFIG.ROOM_SIZE.min}+ players!`); return; }
    setView('game'); 
    setEnded(false);
    endedRef.current = false;
    const init = {}; 
    players.forEach(p => init[p.id] = { influence: 0, debates: 0, wins: 0 }); 
    setScores(init);
    scoresRef.current = init;
    playersRef.current = players;
    const arc = STORY_ARCS[room.theme]; 
    setStory([{ text: arc.opening, type: 'opening' }]); 
    setPath([]);
    setVotes({});
    votesRef.current = {};
    msg(`ğŸ“– ${arc.name} begins!`);
    setTimeout(() => startRd(1, [], room.theme), 2000);
  };

  // FIX: Pass theme explicitly and use ref for ended check
  const startRd = (r, currentPath, theme) => {
    console.log(`[startRd] Round ${r}, Path:`, currentPath, 'Theme:', theme);
    
    if (r > CONFIG.TOTAL_ROUNDS) {
      endGame(currentPath, theme);
      return;
    }
    if (endedRef.current) {
      console.log('[startRd] Game already ended');
      return;
    }
    
    setRound(r); 
    setPhase('debate'); 
    setVotes({});
    votesRef.current = {};
    setMyVote(null); 
    setInput('');
    
    const rd = getRd(r, currentPath, theme); 
    console.log(`[startRd] Round data:`, rd);
    
    if (!rd || !rd.a || !rd.b) { 
      console.error('[startRd] Invalid round data!');
      endGame(currentPath, theme); 
      return; 
    }
    
    setStory(s => [...s, { text: rd.context, type: 'context', round: r }]); 
    setOpts({ a: rd.a, b: rd.b });
    
    msg(`Round ${r}/${CONFIG.TOTAL_ROUNDS} - Debate Phase`);
    setTimer(CONFIG.DEBATE_DURATION); 
    runTimer(CONFIG.DEBATE_DURATION, () => startVote(r, currentPath, theme));
    
    // AI debates
    playersRef.current.filter(x => x.isAI).forEach((ai, i) => setTimeout(() => { 
      if (!endedRef.current) {
        const d = genAI(ai.style); 
        msg(d.text, 'chat', ai, d.choice); 
      }
    }, 2000 * (i + 1) + Math.random() * 3000));
  };

  const startVote = (r, currentPath, theme) => { 
    console.log(`[startVote] Round ${r}`);
    setPhase('vote'); 
    setTimer(CONFIG.VOTE_DURATION); 
    msg('ğŸ—³ï¸ Vote now!'); 
    
    // AI votes - use ref to get current players
    playersRef.current.filter(x => x.isAI).forEach((ai, i) => setTimeout(() => { 
      if (!endedRef.current) {
        const vote = Math.random() > 0.5 ? 'A' : 'B';
        setVotes(v => {
          const newVotes = { ...v, [ai.id]: vote };
          votesRef.current = newVotes;
          return newVotes;
        }); 
      }
    }, 1000 * (i + 1))); 
    
    runTimer(CONFIG.VOTE_DURATION, () => calcRes(r, currentPath, theme)); 
  };

  const runTimer = (dur, cb) => { 
    if (timerRef.current) clearInterval(timerRef.current); 
    let t = dur; 
    setTimer(t); 
    timerRef.current = setInterval(() => { 
      t--; 
      setTimer(t); 
      if (t <= 0) { 
        clearInterval(timerRef.current); 
        timerRef.current = null; 
        cb(); 
      } 
    }, 1000); 
  };

  const submitDebate = () => { 
    if (!input.trim() || phase !== 'debate') return; 
    const c = input.toUpperCase().includes(' A') || input.toUpperCase().includes('OPTION A') ? 'A' : 
              input.toUpperCase().includes(' B') || input.toUpperCase().includes('OPTION B') ? 'B' : null; 
    msg(input, 'chat', player, c); 
    setInput(''); 
    setScores(s => ({ ...s, [player.id]: { ...s[player.id], debates: (s[player.id]?.debates || 0) + CONFIG.DEBATE_BONUS } })); 
  };
  
  const submitVote = (c) => { 
    if (phase !== 'vote' || myVote) return; 
    setMyVote(c); 
    setVotes(v => {
      const newVotes = { ...v, [player.id]: c };
      votesRef.current = newVotes;
      return newVotes;
    }); 
    msg(`You voted ${c}`); 
  };

  const calcRes = async (r, currentPath, theme) => {
    console.log(`[calcRes] Round ${r}, Path:`, currentPath);
    setPhase('result');
    
    // Use ref to get current votes
    const currentVotes = votesRef.current;
    const cnt = { A: 0, B: 0 }; 
    Object.values(currentVotes).forEach(v => { if (v) cnt[v]++; });
    const winner = cnt.A + cnt.B === 0 ? (Math.random() > 0.5 ? 'A' : 'B') : (cnt.A >= cnt.B ? 'A' : 'B');
    
    console.log(`[calcRes] Winner: ${winner}, Votes:`, cnt);
    
    // Update scores using ref
    const currentScores = { ...scoresRef.current }; 
    Object.entries(currentVotes).forEach(([id, v]) => { 
      if (v === winner && currentScores[id]) { 
        currentScores[id].influence += CONFIG.WIN_BONUS; 
        currentScores[id].wins++; 
      } 
    }); 
    setScores(currentScores);
    scoresRef.current = currentScores;
    
    // New path
    const newPath = [...currentPath, winner]; 
    setPath(newPath);
    
    // Get result text
    const rd = STORY_ARCS[theme]?.rounds[r-1];
    const o = winner === 'A' ? rd?.a : rd?.b; 
    const res = getRes(r, winner, currentPath, theme);
    
    setStory(s => [...s, 
      { text: `[Chosen] ${o?.text || 'Option ' + winner}`, type: 'choice', winner }, 
      { text: res, type: 'result' }
    ]);
    msg(`ğŸ“œ Option ${winner} wins! (${cnt[winner]} vs ${cnt[winner === 'A' ? 'B' : 'A']})`);
    
    // Contract call
    if (wallet.connected) {
      await callContract('recordVote', { round: r, winner, path: newPath });
    }
    
    // Next round or end
    if (r >= CONFIG.TOTAL_ROUNDS) {
      console.log('[calcRes] Final round, ending game');
      setTimeout(() => endGame(newPath, theme), 2500);
    } else {
      console.log(`[calcRes] Proceeding to round ${r + 1}`);
      setTimeout(() => startRd(r + 1, newPath, theme), 3000);
    }
  };

  const endGame = async (finalPath, theme) => {
    console.log('[endGame] Path:', finalPath);
    if (endedRef.current) return; 
    setEnded(true);
    endedRef.current = true;
    setPhase('ended');
    
    if (timerRef.current) { 
      clearInterval(timerRef.current); 
      timerRef.current = null; 
    }
    
    const ps = scores[player.id] || { influence: 0, debates: 0 }; 
    const pts = ps.influence + ps.debates;
    const reward = CONFIG.BASE_REWARD + Math.floor(pts / 2);
    
    // Contract call
    if (wallet.connected) {
      await callContract('claimReward', { amount: reward, path: finalPath });
    }
    
    setPlayer(p => ({ ...p, tokens: p.tokens + reward, earned: p.earned + reward }));
    
    const rec = { id: Date.now(), theme: theme, name: STORY_ARCS[theme]?.name || 'Unknown', date: new Date().toISOString(), score: pts, reward };
    const nh = [rec, ...history].slice(0, 30); 
    setHistory(nh); 
    save('cc_h', nh);
    
    const nlb = [...lb, { id: Date.now(), name: player.name, avatar: player.avatar, score: pts, theme }].sort((a, b) => b.score - a.score).slice(0, 15); 
    setLb(nlb); 
    save('cc_lb', nlb);
    
    msg(`ğŸ† Chronicle Complete! +${reward} GLT`);
  };

  const reset = () => { 
    if (timerRef.current) clearInterval(timerRef.current); 
    setView('home'); 
    setRoom(null);
    roomRef.current = null;
    setPlayers([]); 
    setStory([]); 
    setPath([]);
    setRound(0); 
    setPhase('waiting'); 
    setMsgs([]); 
    setVotes({}); 
    setMyVote(null); 
    setEnded(false);
    endedRef.current = false;
    setOpts({ a: null, b: null });
  };
  
  useEffect(() => () => { if (timerRef.current) clearInterval(timerRef.current); }, []);

  // ===== Wallet Button Component =====
  const WalletBtn = () => (
    <div style={{ position: 'fixed', top: '1rem', right: '1rem', zIndex: 1000 }}>
      {wallet.connected ? (
        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.5rem 1rem', background: 'rgba(74,222,128,0.15)', border: '1px solid rgba(74,222,128,0.4)', borderRadius: '20px' }}>
          <span style={{ width: '8px', height: '8px', background: '#4ade80', borderRadius: '50%' }} />
          <span style={{ color: '#4ade80', fontSize: '0.85rem' }}>{wallet.address.slice(0,6)}...{wallet.address.slice(-4)}</span>
          <span style={{ color: '#fbbf24', fontSize: '0.85rem', marginLeft: '0.5rem' }}>{wallet.balance} GLT</span>
          <button onClick={disconnectWallet} style={{ background: 'transparent', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '1rem', marginLeft: '0.3rem' }}>âœ•</button>
        </div>
      ) : (
        <button onClick={connectWallet} disabled={connecting}
          style={{ padding: '0.6rem 1.5rem', background: 'linear-gradient(135deg, #a78bfa, #f472b6)', border: 'none', borderRadius: '20px', color: '#fff', fontWeight: 600, cursor: connecting ? 'wait' : 'pointer', opacity: connecting ? 0.7 : 1 }}>
          {connecting ? 'ğŸ”„ Connecting...' : 'ğŸ”— Connect Wallet'}
        </button>
      )}
    </div>
  );

  // ===== HOME =====
  if (view === 'home') {
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%)', padding: '2rem', fontFamily: 'system-ui', color: '#e8e8e8' }}>
        <WalletBtn />
        <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
          <div style={{ textAlign: 'center', marginBottom: '3rem' }}>
            <div style={{ fontSize: '5rem', marginBottom: '1rem' }}>ğŸ“œ</div>
            <h1 style={{ fontSize: '3rem', fontWeight: 800, background: 'linear-gradient(135deg, #a78bfa, #f472b6, #fb923c)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.5rem' }}>Consensus Chronicle</h1>
            <p style={{ color: '#8b8b9e', letterSpacing: '0.2em', textTransform: 'uppercase', marginBottom: '0.5rem' }}>Powered by GenLayer</p>
            <p style={{ color: '#a5a5b8', fontStyle: 'italic' }}>How does consensus shape history? Your choice will rewrite fate.</p>
          </div>

          {!wallet.connected ? (
            <div style={{ textAlign: 'center', padding: '3rem', background: 'rgba(255,255,255,0.03)', borderRadius: '16px', marginBottom: '2rem' }}>
              <p style={{ color: '#a5a5b8', marginBottom: '1.5rem', fontSize: '1.1rem' }}>Connect your wallet to start playing on GenLayer</p>
              <button onClick={connectWallet} disabled={connecting}
                style={{ padding: '1rem 3rem', fontSize: '1.2rem', background: 'linear-gradient(135deg, #a78bfa, #f472b6)', border: 'none', borderRadius: '12px', color: '#fff', fontWeight: 600, cursor: connecting ? 'wait' : 'pointer' }}>
                {connecting ? 'ğŸ”„ Connecting...' : 'ğŸ”— Connect to GenLayer'}
              </button>
            </div>
          ) : !player.name ? (
            <div style={{ maxWidth: '400px', margin: '0 auto 3rem' }}>
              <input type="text" placeholder="Enter your name to begin..." style={{ width: '100%', padding: '1rem 1.5rem', fontSize: '1.2rem', background: 'rgba(255,255,255,0.05)', border: '2px solid rgba(167,139,250,0.3)', borderRadius: '12px', color: '#fff', outline: 'none' }}
                onKeyDown={e => e.key === 'Enter' && e.target.value.trim() && setPlayer(p => ({ ...p, name: e.target.value.trim() }))} />
              <p style={{ marginTop: '0.5rem', color: '#6b6b7e', fontSize: '0.9rem', textAlign: 'center' }}>Press Enter to confirm</p>
            </div>
          ) : (
            <>
              <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                <div style={{ display: 'inline-flex', alignItems: 'center', gap: '1rem', padding: '1rem 2rem', background: 'rgba(167,139,250,0.1)', borderRadius: '50px', border: '1px solid rgba(167,139,250,0.3)' }}>
                  <span style={{ fontSize: '2rem' }}>{player.avatar}</span>
                  <span style={{ fontSize: '1.3rem', fontWeight: 600 }}>{player.name}</span>
                  <span style={{ color: '#fbbf24', fontWeight: 600 }}>ğŸ’° {player.tokens} GLT</span>
                  <button onClick={() => setView('history')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '20px', padding: '0.5rem 1rem', color: '#a5a5b8', cursor: 'pointer' }}>ğŸ“Š History</button>
                </div>
              </div>

              <h2 style={{ fontSize: '1.5rem', color: '#c4b5fd', marginBottom: '1.5rem', textAlign: 'center' }}>Select Theme Â· {CONFIG.ENTRY_FEE} GLT Entry</h2>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '3rem' }}>
                {Object.entries(STORY_ARCS).map(([key, arc]) => (
                  <button key={key} onClick={() => createRoom(key)} disabled={player.tokens < CONFIG.ENTRY_FEE}
                    style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '2rem', background: 'linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02))', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', cursor: player.tokens >= CONFIG.ENTRY_FEE ? 'pointer' : 'not-allowed', opacity: player.tokens >= CONFIG.ENTRY_FEE ? 1 : 0.5, transition: 'all 0.3s' }}
                    onMouseOver={e => { if (player.tokens >= CONFIG.ENTRY_FEE) { e.currentTarget.style.transform = 'translateY(-5px)'; e.currentTarget.style.borderColor = 'rgba(167,139,250,0.5)'; }}}
                    onMouseOut={e => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.borderColor = 'rgba(255,255,255,0.1)'; }}>
                    <span style={{ fontSize: '3rem', marginBottom: '1rem' }}>{arc.icon}</span>
                    <span style={{ fontSize: '1.2rem', fontWeight: 600, color: '#fff' }}>{arc.name}</span>
                    <span style={{ fontSize: '0.85rem', color: '#6b6b7e', marginTop: '0.5rem' }}>{arc.desc}</span>
                  </button>
                ))}
              </div>

              <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '1.5rem' }}>
                <h3 style={{ fontSize: '1.3rem', color: '#fbbf24', marginBottom: '1rem' }}>ğŸ† Chronicle Leaderboard</h3>
                {lb.length === 0 ? <p style={{ color: '#6b6b7e', textAlign: 'center', padding: '2rem' }}>No records yet. Be the first chronicler!</p> :
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    {lb.slice(0, 10).map((e, i) => (
                      <div key={e.id} style={{ display: 'flex', alignItems: 'center', gap: '1rem', padding: '0.8rem 1rem', background: i < 3 ? `rgba(251,191,36,${0.2 - i * 0.05})` : 'rgba(255,255,255,0.02)', borderRadius: '8px', border: i === 0 ? '1px solid rgba(251,191,36,0.3)' : 'none' }}>
                        <span style={{ fontWeight: 700, color: i < 3 ? '#fbbf24' : '#6b6b7e', width: '2rem' }}>#{i + 1}</span>
                        <span style={{ fontSize: '1.5rem' }}>{e.avatar}</span>
                        <span style={{ flex: 1, color: '#fff' }}>{e.name}</span>
                        <span style={{ fontSize: '0.85rem', color: '#8b8b9e' }}>{STORY_ARCS[e.theme]?.icon}</span>
                        <span style={{ fontWeight: 600, color: '#a78bfa' }}>{e.score} pts</span>
                      </div>
                    ))}
                  </div>}
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  // ===== HISTORY =====
  if (view === 'history') {
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%)', padding: '2rem', fontFamily: 'system-ui', color: '#e8e8e8' }}>
        <WalletBtn />
        <div style={{ maxWidth: '600px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
            <button onClick={() => setView('home')} style={{ background: 'transparent', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', padding: '0.5rem 1rem', color: '#a5a5b8', cursor: 'pointer' }}>â† Back</button>
            <h2 style={{ color: '#fff', fontWeight: 600 }}>Game History</h2>
            <div />
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem', marginBottom: '2rem' }}>
            <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '1.5rem', textAlign: 'center' }}>
              <div style={{ fontSize: '2rem', fontWeight: 700, color: '#fbbf24' }}>{player.tokens}</div>
              <div style={{ fontSize: '0.85rem', color: '#6b6b7e' }}>Balance (GLT)</div>
            </div>
            <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '1.5rem', textAlign: 'center' }}>
              <div style={{ fontSize: '2rem', fontWeight: 700, color: '#4ade80' }}>{player.earned}</div>
              <div style={{ fontSize: '0.85rem', color: '#6b6b7e' }}>Earned</div>
            </div>
            <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '1.5rem', textAlign: 'center' }}>
              <div style={{ fontSize: '2rem', fontWeight: 700, color: '#a78bfa' }}>{history.length}</div>
              <div style={{ fontSize: '0.85rem', color: '#6b6b7e' }}>Games</div>
            </div>
          </div>
          {history.length === 0 ? <p style={{ color: '#6b6b7e', textAlign: 'center', padding: '2rem' }}>No games yet</p> :
            history.slice(0, 10).map((r, i) => (
              <div key={r.id} style={{ display: 'flex', alignItems: 'center', gap: '1rem', padding: '1rem', background: 'rgba(255,255,255,0.03)', borderRadius: '8px', marginBottom: '0.5rem' }}>
                <span style={{ fontSize: '2rem' }}>{STORY_ARCS[r.theme]?.icon}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontWeight: 600, color: '#fff' }}>{r.name}</div>
                  <div style={{ fontSize: '0.8rem', color: '#6b6b7e' }}>{new Date(r.date).toLocaleDateString()}</div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ color: '#a78bfa', fontWeight: 600 }}>{r.score} pts</div>
                  <div style={{ color: '#4ade80', fontSize: '0.9rem' }}>+{r.reward} GLT</div>
                </div>
              </div>
            ))}
        </div>
      </div>
    );
  }

  // ===== ROOM =====
  if (view === 'room') {
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%)', padding: '2rem', fontFamily: 'system-ui', color: '#e8e8e8' }}>
        <WalletBtn />
        <div style={{ maxWidth: '700px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem', paddingBottom: '1rem', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
            <button onClick={reset} style={{ padding: '0.5rem 1rem', background: 'transparent', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#a5a5b8', cursor: 'pointer' }}>â† Leave</button>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '1.3rem' }}>
              <span>{STORY_ARCS[room?.theme]?.icon}</span>
              <span style={{ color: '#fff', fontWeight: 600 }}>{STORY_ARCS[room?.theme]?.name}</span>
            </div>
            <span style={{ fontSize: '0.9rem', color: '#6b6b7e', fontFamily: 'monospace' }}>{room?.id?.slice(-8)}</span>
          </div>
          
          <h3 style={{ fontSize: '1.1rem', color: '#8b8b9e', marginBottom: '1rem' }}>Players ({players.length}/{CONFIG.ROOM_SIZE.max})</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem', marginBottom: '2rem' }}>
            {players.map(p => (
              <div key={p.id} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '1.5rem 1rem', background: p.id === player.id ? 'rgba(167,139,250,0.1)' : 'rgba(255,255,255,0.03)', border: `1px solid ${p.id === player.id ? 'rgba(167,139,250,0.5)' : 'rgba(255,255,255,0.1)'}`, borderRadius: '12px', position: 'relative' }}>
                <span style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>{p.avatar}</span>
                <span style={{ fontSize: '0.95rem', textAlign: 'center' }}>{p.name}</span>
                {p.isAI && <span style={{ position: 'absolute', top: '0.5rem', left: '0.5rem', fontSize: '0.6rem', padding: '0.2rem 0.4rem', background: '#3b82f6', borderRadius: '4px' }}>AI</span>}
                {p.id === room?.host && <span style={{ position: 'absolute', top: '0.5rem', right: '0.5rem', fontSize: '0.6rem', padding: '0.2rem 0.4rem', background: '#fbbf24', color: '#000', borderRadius: '4px' }}>Host</span>}
              </div>
            ))}
            {Array(CONFIG.ROOM_SIZE.max - players.length).fill(0).map((_, i) => (
              <div key={`e${i}`} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '1.5rem 1rem', border: '1px dashed rgba(255,255,255,0.1)', borderRadius: '12px', opacity: 0.4 }}>
                <span style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>?</span>
                <span style={{ fontSize: '0.95rem', color: '#6b6b7e' }}>Waiting...</span>
              </div>
            ))}
          </div>

          {player.id === room?.host && (
            <button onClick={startGame} disabled={players.length < CONFIG.ROOM_SIZE.min}
              style={{ width: '100%', padding: '1rem', fontSize: '1.2rem', fontWeight: 600, border: 'none', borderRadius: '12px', cursor: players.length >= CONFIG.ROOM_SIZE.min ? 'pointer' : 'not-allowed', background: players.length >= CONFIG.ROOM_SIZE.min ? 'linear-gradient(135deg, #a78bfa, #f472b6)' : 'rgba(255,255,255,0.1)', color: players.length >= CONFIG.ROOM_SIZE.min ? '#fff' : '#6b6b7e' }}>
              {players.length >= CONFIG.ROOM_SIZE.min ? 'ğŸ® Start Game' : `Waiting for ${CONFIG.ROOM_SIZE.min - players.length} more`}
            </button>
          )}

          <div style={{ marginTop: '2rem', padding: '1.5rem', background: 'rgba(255,255,255,0.03)', borderRadius: '12px' }}>
            <h4 style={{ marginBottom: '1rem', color: '#c4b5fd' }}>ğŸ“– How to Play</h4>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '0.5rem', marginBottom: '1rem' }}>
              {[1,2,3,4,5].map(n => (
                <div key={n} style={{ textAlign: 'center', padding: '0.5rem', background: 'rgba(167,139,250,0.1)', borderRadius: '8px' }}>
                  <div style={{ fontSize: '1.1rem', fontWeight: 700, color: '#a78bfa' }}>R{n}</div>
                </div>
              ))}
            </div>
            <ul style={{ listStyle: 'none', padding: 0, color: '#a5a5b8', fontSize: '0.9rem' }}>
              <li style={{ padding: '0.3rem 0' }}>ğŸ’¬ <b>Debate</b>: Share arguments</li>
              <li style={{ padding: '0.3rem 0' }}>ğŸ—³ï¸ <b>Vote</b>: Choose A or B</li>
              <li style={{ padding: '0.3rem 0' }}>ğŸ“œ <b>Story</b>: Majority decides</li>
              <li style={{ padding: '0.3rem 0' }}>ğŸ† <b>Reward</b>: Earn GLT</li>
            </ul>
          </div>
        </div>
      </div>
    );
  }

  // ===== GAME =====
  return (
    <div style={{ height: '100vh', background: 'linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%)', display: 'flex', flexDirection: 'column', fontFamily: 'system-ui', color: '#e8e8e8', overflow: 'hidden' }}>
      <WalletBtn />
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem 2rem', background: 'rgba(0,0,0,0.3)', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
        <div>
          <div style={{ fontSize: '0.9rem', color: '#8b8b9e' }}>Round {round} / {CONFIG.TOTAL_ROUNDS}</div>
          <div style={{ fontSize: '1.1rem', fontWeight: 600 }}>
            {phase === 'debate' && 'ğŸ’¬ Debate'}{phase === 'vote' && 'ğŸ—³ï¸ Voting'}{phase === 'result' && 'ğŸ“Š Results'}{phase === 'ended' && 'ğŸ† Complete'}
          </div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          {[1,2,3,4,5].map(n => <div key={n} style={{ width: '12px', height: '12px', borderRadius: '50%', background: n < round ? '#4ade80' : n === round ? '#a78bfa' : 'rgba(255,255,255,0.2)' }} />)}
        </div>
        <div style={{ fontSize: '2.5rem', fontWeight: 700, fontFamily: 'monospace', color: timer <= 10 && phase !== 'ended' && phase !== 'result' ? '#f87171' : '#a78bfa' }}>{phase === 'ended' || phase === 'result' ? '--:--' : fmt(timer)}</div>
        <div style={{ textAlign: 'right' }}>
          <div style={{ fontSize: '0.85rem', color: '#8b8b9e' }}>Score</div>
          <div style={{ fontSize: '1.5rem', fontWeight: 700, color: '#fbbf24' }}>{(scores[player.id]?.influence || 0) + (scores[player.id]?.debates || 0)}</div>
        </div>
      </div>

      {/* Main */}
      <div style={{ flex: 1, display: 'flex', gap: '1rem', padding: '1rem', overflow: 'hidden' }}>
        {/* Left - Story */}
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '1rem', minWidth: 0 }}>
          <div style={{ flex: 1, background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '1rem', overflowY: 'auto' }}>
            <h3 style={{ color: '#c4b5fd', marginBottom: '1rem', fontSize: '1rem' }}>ğŸ“œ {STORY_ARCS[room?.theme]?.name}</h3>
            {story.map((s, i) => (
              <div key={i} style={{ padding: '0.6rem 0', borderBottom: i < story.length - 1 ? '1px solid rgba(255,255,255,0.05)' : 'none' }}>
                {s.type === 'opening' && <p style={{ color: '#c4b5fd', fontStyle: 'italic', lineHeight: 1.7 }}>{s.text}</p>}
                {s.type === 'context' && <p style={{ color: '#fbbf24', lineHeight: 1.7 }}><span style={{ background: 'rgba(251,191,36,0.2)', padding: '0.2rem 0.5rem', borderRadius: '4px', marginRight: '0.5rem' }}>R{s.round}</span>{s.text}</p>}
                {s.type === 'choice' && <p style={{ color: '#4ade80', lineHeight: 1.7 }}><span style={{ marginRight: '0.5rem' }}>{s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'}</span>{s.text}</p>}
                {s.type === 'result' && <p style={{ color: '#a5a5b8', lineHeight: 1.7, paddingLeft: '1.5rem', borderLeft: '2px solid rgba(167,139,250,0.3)' }}>{s.text}</p>}
              </div>
            ))}
          </div>

          {/* Options */}
          {(phase === 'debate' || phase === 'vote') && opts.a && opts.b && (
            <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: '12px', padding: '1rem' }}>
              <h4 style={{ textAlign: 'center', marginBottom: '1rem', color: '#fff' }}>âš”ï¸ Decision</h4>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                {[{ key: 'A', opt: opts.a, color: '#ef4444' }, { key: 'B', opt: opts.b, color: '#3b82f6' }].map(({ key, opt, color }) => (
                  <div key={key} onClick={() => phase === 'vote' && submitVote(key)}
                    style={{ padding: '1rem', borderRadius: '10px', border: `2px solid ${myVote === key ? color : `${color}40`}`, background: `${color}15`, cursor: phase === 'vote' ? 'pointer' : 'default', transition: 'all 0.3s', transform: myVote === key ? 'scale(1.02)' : 'scale(1)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.8rem' }}>
                      <span style={{ fontWeight: 700, fontSize: '1.1rem', color }}>Option {key}</span>
                      <span style={{ fontSize: '0.75rem', padding: '0.2rem 0.5rem', background: 'rgba(255,255,255,0.1)', borderRadius: '4px', color: '#a5a5b8' }}>{opt.tag}</span>
                    </div>
                    <p style={{ lineHeight: 1.5, fontSize: '0.9rem', color: '#e8e8e8' }}>{opt.text}</p>
                    {phase === 'vote' && <div style={{ marginTop: '0.8rem', textAlign: 'center', fontSize: '1.2rem', fontWeight: 600, color: '#fbbf24' }}>{Object.values(votes).filter(v => v === key).length} votes</div>}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* End */}
          {phase === 'ended' && (
            <div style={{ background: 'linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1))', borderRadius: '12px', padding: '2rem', textAlign: 'center' }}>
              <h2 style={{ fontSize: '1.8rem', marginBottom: '1.5rem', color: '#fbbf24' }}>ğŸ† Chronicle Complete!</h2>
              <div style={{ maxWidth: '400px', margin: '0 auto 1.5rem' }}>
                {Object.entries(scores).map(([id, score]) => ({ player: players.find(p => p.id === id), total: (score.influence || 0) + (score.debates || 0) })).sort((a, b) => b.total - a.total).map((rank, i) => (
                  <div key={rank.player?.id || i} style={{ display: 'flex', alignItems: 'center', gap: '0.8rem', padding: '0.8rem', marginBottom: '0.4rem', background: i === 0 ? 'rgba(251,191,36,0.2)' : 'rgba(255,255,255,0.03)', borderRadius: '8px', border: i === 0 ? '1px solid rgba(251,191,36,0.3)' : 'none' }}>
                    <span style={{ fontWeight: 700, color: i < 3 ? '#fbbf24' : '#6b6b7e', width: '1.5rem' }}>#{i + 1}</span>
                    <span style={{ fontSize: '1.3rem' }}>{rank.player?.avatar}</span>
                    <span style={{ flex: 1, color: '#fff' }}>{rank.player?.name}</span>
                    <span style={{ fontWeight: 600, color: '#a78bfa' }}>{rank.total} pts</span>
                  </div>
                ))}
              </div>
              <div style={{ margin: '1.5rem 0', padding: '1rem', background: 'rgba(74,222,128,0.1)', borderRadius: '8px', border: '1px solid rgba(74,222,128,0.2)' }}>
                <div style={{ fontSize: '0.9rem', color: '#6b6b7e' }}>Your Reward</div>
                <div style={{ fontSize: '1.8rem', fontWeight: 700, color: '#4ade80' }}>+{CONFIG.BASE_REWARD + Math.floor(((scores[player.id]?.influence || 0) + (scores[player.id]?.debates || 0)) / 2)} GLT</div>
              </div>
              <button onClick={reset} style={{ padding: '0.8rem 2rem', background: 'linear-gradient(135deg, #a78bfa, #f472b6)', border: 'none', borderRadius: '10px', color: '#fff', fontSize: '1rem', fontWeight: 600, cursor: 'pointer' }}>Return Home</button>
            </div>
          )}
        </div>

        {/* Right - Chat */}
        <div style={{ width: '320px', display: 'flex', flexDirection: 'column', background: 'rgba(0,0,0,0.2)', borderRadius: '12px', overflow: 'hidden' }}>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem', padding: '0.8rem', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            {players.map(p => (
              <div key={p.id} style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', padding: '0.3rem 0.6rem', background: votes[p.id] ? 'rgba(74,222,128,0.2)' : 'rgba(255,255,255,0.05)', borderRadius: '15px', fontSize: '0.8rem', border: votes[p.id] ? '1px solid rgba(74,222,128,0.4)' : '1px solid transparent' }}>
                <span>{p.avatar}</span>
                <span style={{ maxWidth: '60px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{p.name}</span>
                {votes[p.id] && <span style={{ color: '#4ade80', fontWeight: 700 }}>{votes[p.id]}</span>}
              </div>
            ))}
          </div>
          
          <div ref={chatRef} style={{ flex: 1, overflowY: 'auto', padding: '0.8rem' }}>
            {msgs.map(m => (
              <div key={m.id} style={{ marginBottom: '0.6rem', fontSize: '0.85rem' }}>
                {m.type === 'system' ? <div style={{ color: '#a78bfa', fontStyle: 'italic', padding: '0.3rem 0' }}>{m.text}</div> : (
                  <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '8px', padding: '0.5rem 0.8rem' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.3rem' }}>
                      <span style={{ color: '#fbbf24', fontWeight: 600 }}>{m.sender?.avatar} {m.sender?.name}</span>
                      {m.choice && <span style={{ fontSize: '0.7rem', padding: '0.1rem 0.4rem', background: m.choice === 'A' ? 'rgba(239,68,68,0.3)' : 'rgba(59,130,246,0.3)', borderRadius: '4px' }}>{m.choice}</span>}
                    </div>
                    <div style={{ color: '#e8e8e8' }}>{m.text}</div>
                  </div>
                )}
              </div>
            ))}
          </div>

          {phase === 'debate' && (
            <div style={{ padding: '0.8rem', borderTop: '1px solid rgba(255,255,255,0.05)' }}>
              <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && submitDebate()}
                  placeholder="Share your argument..." style={{ flex: 1, padding: '0.6rem 0.8rem', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '0.85rem', outline: 'none' }} />
                <button onClick={submitDebate} style={{ padding: '0.6rem 1rem', background: 'linear-gradient(135deg, #a78bfa, #f472b6)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: 600, cursor: 'pointer' }}>Send</button>
              </div>
              <div style={{ display: 'flex', gap: '0.4rem' }}>
                <button onClick={() => setInput('I support A because ')} style={{ padding: '0.3rem 0.6rem', background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '15px', color: '#ef4444', fontSize: '0.75rem', cursor: 'pointer' }}>ğŸ…°ï¸ A</button>
                <button onClick={() => setInput('I support B because ')} style={{ padding: '0.3rem 0.6rem', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '15px', color: '#3b82f6', fontSize: '0.75rem', cursor: 'pointer' }}>ğŸ…±ï¸ B</button>
              </div>
            </div>
          )}
          
          {phase === 'vote' && !myVote && (
            <div style={{ padding: '1rem', textAlign: 'center', background: 'rgba(167,139,250,0.1)' }}>
              <p style={{ color: '#fbbf24', fontWeight: 600 }}>â° Click option to vote!</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
